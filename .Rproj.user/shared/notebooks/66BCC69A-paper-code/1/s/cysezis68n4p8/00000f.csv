"0","# Create spatial weights matrix using queen contiguity scheme"
"0",""
"0","clustering_data <- na.omit(london_polygon)"
"0",""
"0","# Contiguity style weights matrix according to queen criterion"
"0","weights <- poly2nb(clustering_data, queen = TRUE, snap = 1e-5) #boundaries <snap distance apart are contiguous "
"0","# row standardised spatial weights"
"0","weights <- nb2listw(weights, style = ""W"")"
"0",""
"0","# Global Moran's I for PC1"
"0","gmi <- moran.test(clustering_data$PC1, listw = weights)"
"0",""
"0","# LISA cluster instead?"
"0","# Compute Local Moran's I"
"0","# In addition, we output an attribute data frame ""quadr"" with mean and median quadrant columns, and a column splitting on the demeaned variable and lagged demeaned variable at zero."
"0","lisa <- localmoran(clustering_data$PC1, weights)"
"0","summary(lisa)"
"1",""
"1","       Ii          "
"1","      E.Ii           "
"1","     Var.Ii       "
"1","
"
"1"," Min.   :-3.50518  "
"1"," Min.   :-7.511e-03  "
"1"," Min.   :0.00000  "
"1","
"
"1"," 1st Qu.: 0.01978  "
"1"," 1st Qu.:-3.777e-04  "
"1"," 1st Qu.:0.01577  "
"1","
"
"1"," Median : 0.25305  "
"1"," Median :-1.194e-04  "
"1"," Median :0.07113  "
"1","
"
"1"," Mean   : 0.70452  "
"1"," Mean   :-2.976e-04  "
"1"," Mean   :0.18564  "
"1","
"
"1"," 3rd Qu.: 0.95240  "
"1"," 3rd Qu.:-2.839e-05  "
"1"," 3rd Qu.:0.22517  "
"1","
"
"1"," Max.   : 9.22180  "
"1"," Max.   : 0.000e+00  "
"1"," Max.   :4.90220  "
"1","
"
"1",""
"1","      Z.Ii        "
"1"," Pr(z != E(Ii))   "
"1","
"
"1"," Min.   :-4.7575  "
"1"," Min.   :0.00000  "
"1","
"
"1"," 1st Qu.: 0.2542  "
"1"," 1st Qu.:0.02134  "
"1","
"
"1"," Median : 1.1693  "
"1"," Median :0.20392  "
"1","
"
"1"," Mean   : 1.3394  "
"1"," Mean   :0.31653  "
"1","
"
"1"," 3rd Qu.: 2.2757  "
"1"," 3rd Qu.:0.57135  "
"1","
"
"1"," Max.   : 6.9240  "
"1"," Max.   :0.99940  "
"1","
"
"0","# LISA clusters according to significance level of 0.05"
"0","significance <- 0.05"
"0","clustering_data$clusters <- attributes(lisa)$quadr$mean"
"0",""
"0","clustering_data$clusters[lisa[ ,5] > significance] <- ""Insignificant"""
"2","Warning in `[<-.factor`(`*tmp*`, lisa[, 5] > significance, value = ""Insignificant"") :"
"2","
 "
"2"," invalid factor level, NA generated
"
"0","clustering_data <- clustering_data %>%"
"0","  mutate(clusters = case_when("
"0","    is.na(clusters) ~ ""Insignificant"","
"0","    TRUE ~ as.factor(clusters)))"
"0",""
"0","clustering_data$clusters <- factor(clustering_data$clusters, levels=c(""Low-Low"",""Low-High"",""High-Low"",""High-High"",""Insignificant""))"
"0","           "
"0","# LH and HL are coded as ""Insignificant"" here - we aren't interested in these"
"0","clustering_data <- clustering_data %>%"
"0","  mutate(clusters_HH_LL = case_when("
"0","    clusters == ""Low-Low"" ~ ""Low-Low"","
"0","    clusters == ""High-High"" ~ ""High-High"","
"0","    TRUE ~ NA_character_"
"0","  ))"
